#!/bin/bash

# Kiosk Admin CLI Tool
# Provides recovery and management commands for the kiosk application

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Paths
if [ -d "/var/www/kiosk" ]; then
  # Production (Pi)
  KIOSK_DIR="/var/www/kiosk"
  DATA_DIR="${KIOSK_DIR}/server/data"
  SERVICE_NAME="kiosk-photo-server"
else
  # Development
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  KIOSK_DIR="$(dirname "$SCRIPT_DIR")"
  DATA_DIR="${KIOSK_DIR}/server/data"
  SERVICE_NAME=""
fi

AUTH_FILE="${DATA_DIR}/auth.json"
CONFIG_FILE="${DATA_DIR}/config.enc.json"
SECRET_FILE="${DATA_DIR}/machine.secret"

# Print colored message
print_success() {
  echo -e "${GREEN}✓${NC} $1"
}

print_error() {
  echo -e "${RED}✗${NC} $1"
}

print_warning() {
  echo -e "${YELLOW}⚠${NC} $1"
}

print_info() {
  echo -e "${BLUE}ℹ${NC} $1"
}

# Check if running as root (required for service operations)
check_root() {
  if [ "$EUID" -ne 0 ] && [ -n "$SERVICE_NAME" ]; then
    print_error "This command requires root privileges on production"
    echo "Please run with: sudo kiosk-admin $1"
    exit 1
  fi
}

# Restart the backend service
restart_service() {
  if [ -n "$SERVICE_NAME" ]; then
    print_info "Restarting ${SERVICE_NAME} service..."
    systemctl restart "${SERVICE_NAME}"
    sleep 2

    if systemctl is-active --quiet "${SERVICE_NAME}"; then
      print_success "Service restarted successfully"
    else
      print_error "Service failed to restart"
      print_info "Check logs with: journalctl -u ${SERVICE_NAME} -n 50"
      exit 1
    fi
  else
    print_warning "Development mode: Please restart server manually"
    print_info "Run: cd server && npm run dev"
  fi
}

# Generate new setup code
generate_setup_code() {
  # Characters for code generation (no ambiguous chars)
  chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'
  code=""
  for i in {1..6}; do
    code="${code}${chars:RANDOM%${#chars}:1}"
  done
  echo "$code"
}

# Command: reset-pin
reset_pin() {
  echo ""
  echo "=========================================="
  echo "  PIN Reset"
  echo "=========================================="
  echo ""

  # Check if setup is complete
  if [ ! -f "$AUTH_FILE" ]; then
    print_error "No auth data found. System not set up yet."
    print_info "Visit http://$(hostname -I | awk '{print $1}')/admin to set up"
    exit 1
  fi

  # Show what will happen
  print_info "This will:"
  echo "  • Delete admin PIN (auth.json)"
  echo "  • Preserve settings (config.enc.json)"
  echo "  • Generate new setup code"
  echo "  • Restart backend service"
  echo ""

  # Confirm
  read -p "Continue? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    print_info "Cancelled"
    exit 0
  fi

  # Backup auth file
  if [ -f "$AUTH_FILE" ]; then
    cp "$AUTH_FILE" "${AUTH_FILE}.backup"
    print_info "Created backup: ${AUTH_FILE}.backup"
  fi

  # Generate new code and create new auth file
  NEW_CODE=$(generate_setup_code)
  EXPIRY=$(($(date +%s) * 1000 + 900000)) # 15 minutes from now

  cat > "$AUTH_FILE" << EOF
{
  "pinHash": "",
  "salt": "",
  "setupComplete": false,
  "firstTimeCode": "${NEW_CODE}",
  "firstTimeCodeExpiry": ${EXPIRY}
}
EOF

  chmod 600 "$AUTH_FILE"
  print_success "Auth file reset"

  # Restart service
  restart_service

  # Display new code
  echo ""
  echo "=========================================="
  print_success "PIN Reset Complete"
  echo "=========================================="
  echo ""
  echo -e "${GREEN}Setup Code: ${BLUE}${NEW_CODE}${NC}"
  echo ""
  print_info "Code expires in 15 minutes"
  print_info "Your settings have been preserved"
  echo ""

  # Get IP address
  if command -v hostname &> /dev/null; then
    # Try Linux method first, then macOS
    IP=$(hostname -I 2>/dev/null | awk '{print $1}')
    if [ -z "$IP" ] && command -v ipconfig &> /dev/null; then
      # macOS fallback
      IP=$(ipconfig getifaddr en0 2>/dev/null || ipconfig getifaddr en1 2>/dev/null)
    fi
    if [ -n "$IP" ]; then
      echo "Visit: ${BLUE}http://${IP}/admin/setup/wizard${NC}"
      echo ""
    fi
  fi

  echo "Steps:"
  echo "1. Visit /admin/setup/wizard on your phone or laptop"
  echo "2. Enter code: ${NEW_CODE}"
  echo "3. Create new PIN"
  echo "4. Your settings will remain unchanged"
  echo ""
}

# Command: factory-reset
factory_reset() {
  echo ""
  echo "=========================================="
  echo "  Factory Reset"
  echo "=========================================="
  echo ""

  # Show warning
  print_warning "WARNING: This will DELETE ALL DATA"
  echo ""
  echo "The following will be permanently deleted:"
  echo "  • Admin PIN (auth.json)"
  echo "  • All settings (config.enc.json)"
  echo "  • Encryption key (machine.secret)"
  echo "  • Location, API keys, calendar, photos config"
  echo ""
  print_error "THIS CANNOT BE UNDONE"
  echo ""

  # Double confirmation
  read -p "Type 'DELETE' to confirm: " confirm
  if [ "$confirm" != "DELETE" ]; then
    print_info "Cancelled (confirmation did not match)"
    exit 0
  fi

  read -p "Are you absolutely sure? (y/N): " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    print_info "Cancelled"
    exit 0
  fi

  # Backup files if they exist
  BACKUP_DIR="${DATA_DIR}/backup-$(date +%Y%m%d-%H%M%S)"
  if [ -d "$DATA_DIR" ] && [ "$(ls -A $DATA_DIR 2>/dev/null)" ]; then
    mkdir -p "$BACKUP_DIR"
    cp -r "$DATA_DIR"/* "$BACKUP_DIR" 2>/dev/null || true
    print_info "Backup created: ${BACKUP_DIR}"
  fi

  # Delete all data
  if [ -f "$AUTH_FILE" ]; then
    rm -f "$AUTH_FILE"
    print_success "Deleted: auth.json"
  fi

  if [ -f "$CONFIG_FILE" ]; then
    rm -f "$CONFIG_FILE"
    print_success "Deleted: config.enc.json"
  fi

  if [ -f "$SECRET_FILE" ]; then
    rm -f "$SECRET_FILE"
    print_success "Deleted: machine.secret"
  fi

  # Remove data directory if empty
  if [ -d "$DATA_DIR" ] && [ ! "$(ls -A $DATA_DIR)" ]; then
    rmdir "$DATA_DIR"
    print_info "Removed empty data directory"
  fi

  # Restart service
  restart_service

  # Done
  echo ""
  echo "=========================================="
  print_success "Factory Reset Complete"
  echo "=========================================="
  echo ""
  print_info "All data has been deleted"
  print_info "System is now in factory default state"
  echo ""

  # Get IP address
  if command -v hostname &> /dev/null; then
    # Try Linux method first, then macOS
    IP=$(hostname -I 2>/dev/null | awk '{print $1}')
    if [ -z "$IP" ] && command -v ipconfig &> /dev/null; then
      # macOS fallback
      IP=$(ipconfig getifaddr en0 2>/dev/null || ipconfig getifaddr en1 2>/dev/null)
    fi
    if [ -n "$IP" ]; then
      echo "Visit: ${BLUE}http://${IP}/admin${NC}"
      echo ""
    fi
  fi

  echo "Next steps:"
  echo "1. Visit /admin to start first-time setup"
  echo "2. Click 'Start Setup' to generate code"
  echo "3. Complete setup wizard with new PIN"
  echo ""
}

# Command: status
status() {
  echo ""
  echo "=========================================="
  echo "  Kiosk Status"
  echo "=========================================="
  echo ""

  # Check setup state
  if [ ! -f "$AUTH_FILE" ]; then
    print_warning "Setup: Not configured"
    print_info "Run 'kiosk-admin reset-pin' or visit /admin to set up"
  else
    SETUP_COMPLETE=$(grep -o '"setupComplete":\s*\(true\|false\)' "$AUTH_FILE" | cut -d: -f2 | tr -d ' ')
    FIRST_TIME_CODE=$(grep -o '"firstTimeCode":\s*"[^"]*"' "$AUTH_FILE" | cut -d: -f2 | tr -d '"' | tr -d ' ')

    if [ "$SETUP_COMPLETE" = "true" ]; then
      print_success "Setup: Complete"
    else
      print_warning "Setup: In progress"
      if [ -n "$FIRST_TIME_CODE" ]; then
        echo "  Code: ${BLUE}${FIRST_TIME_CODE}${NC}"
      fi
    fi
  fi

  echo ""
  echo "Data Files:"
  echo "-------------------------------------------"

  if [ -f "$AUTH_FILE" ]; then
    SIZE=$(ls -lh "$AUTH_FILE" | awk '{print $5}')
    PERMS=$(ls -l "$AUTH_FILE" | awk '{print $1}')
    print_success "auth.json        ${SIZE} ${PERMS}"
  else
    print_error "auth.json        Not found"
  fi

  if [ -f "$CONFIG_FILE" ]; then
    SIZE=$(ls -lh "$CONFIG_FILE" | awk '{print $5}')
    PERMS=$(ls -l "$CONFIG_FILE" | awk '{print $1}')
    print_success "config.enc.json  ${SIZE} ${PERMS}"
  else
    print_warning "config.enc.json  Not found"
  fi

  if [ -f "$SECRET_FILE" ]; then
    SIZE=$(ls -lh "$SECRET_FILE" | awk '{print $5}')
    PERMS=$(ls -l "$SECRET_FILE" | awk '{print $1}')
    print_success "machine.secret   ${SIZE} ${PERMS}"
  else
    print_warning "machine.secret   Not found"
  fi

  echo ""

  # Check service status
  if [ -n "$SERVICE_NAME" ]; then
    echo "Service Status:"
    echo "-------------------------------------------"
    if systemctl is-active --quiet "${SERVICE_NAME}"; then
      print_success "${SERVICE_NAME} is running"

      # Show service uptime
      UPTIME=$(systemctl show "${SERVICE_NAME}" --property=ActiveEnterTimestamp --value)
      if [ -n "$UPTIME" ]; then
        echo "  Started: ${UPTIME}"
      fi
    else
      print_error "${SERVICE_NAME} is not running"
      print_info "Start with: sudo systemctl start ${SERVICE_NAME}"
    fi
    echo ""
  fi

  # Show disk usage
  if [ -d "$DATA_DIR" ]; then
    echo "Disk Usage:"
    echo "-------------------------------------------"
    DISK_USAGE=$(du -sh "$DATA_DIR" 2>/dev/null | awk '{print $1}')
    echo "Data directory: ${DISK_USAGE}"
    echo ""
  fi

  # Show network info
  echo "Network:"
  echo "-------------------------------------------"
  if command -v hostname &> /dev/null; then
    HOSTNAME=$(hostname)
    echo "Hostname: ${HOSTNAME}"

    # Try Linux method first, then macOS
    IP=$(hostname -I 2>/dev/null | awk '{print $1}')
    if [ -z "$IP" ] && command -v ipconfig &> /dev/null; then
      # macOS fallback
      IP=$(ipconfig getifaddr en0 2>/dev/null || ipconfig getifaddr en1 2>/dev/null)
    fi
    if [ -n "$IP" ]; then
      echo "IP Address: ${BLUE}${IP}${NC}"
      echo "Admin URL: ${BLUE}http://${IP}/admin${NC}"
    fi
  fi
  echo ""
}

# Command: help
show_help() {
  cat << EOF

Kiosk Admin CLI Tool
====================

Manage the kiosk application configuration and recovery.

COMMANDS:

  reset-pin
      Reset admin PIN without losing settings
      • Deletes PIN (auth.json)
      • Preserves settings (config.enc.json)
      • Generates new 6-character setup code
      • Restarts backend service

      Use this when you forget your PIN but want to keep
      your API keys, location, and other settings.

  factory-reset
      Delete all data and return to factory defaults
      • Deletes PIN (auth.json)
      • Deletes settings (config.enc.json)
      • Deletes encryption key (machine.secret)
      • Restarts backend service

      Use this for a complete fresh start. Creates backup
      before deletion.

  status
      Show current setup state and system information
      • Setup completion status
      • Data file listing with sizes
      • Service status (if applicable)
      • Network information

      Use this to check if setup is complete and view
      system health.

  help
      Show this help message

EXAMPLES:

  # Reset PIN (preserves settings)
  sudo kiosk-admin reset-pin

  # Complete factory reset
  sudo kiosk-admin factory-reset

  # Check system status
  sudo kiosk-admin status

PATHS:

  Kiosk Directory: ${KIOSK_DIR}
  Data Directory:  ${DATA_DIR}

FILES:

  auth.json        - PIN hash and setup state
  config.enc.json  - Encrypted configuration
  machine.secret   - Encryption key (32 bytes)

For more help, visit: https://github.com/yourusername/kiosk-app

EOF
}

# Main command dispatcher
main() {
  case "$1" in
    reset-pin)
      check_root "$1"
      reset_pin
      ;;
    factory-reset)
      check_root "$1"
      factory_reset
      ;;
    status)
      status
      ;;
    help|--help|-h)
      show_help
      ;;
    *)
      if [ -z "$1" ]; then
        print_error "No command specified"
      else
        print_error "Unknown command: $1"
      fi
      echo ""
      echo "Usage: kiosk-admin <command>"
      echo ""
      echo "Commands:"
      echo "  reset-pin      Reset PIN (preserves settings)"
      echo "  factory-reset  Delete all data"
      echo "  status         Show system status"
      echo "  help           Show detailed help"
      echo ""
      echo "Run 'kiosk-admin help' for more information"
      exit 1
      ;;
  esac
}

# Run main function
main "$@"
